name: Create release and upload to Apple and Google
on:
  #  push:
  #    tags:
  #      - 'v[0-9]+.[0-9]+.[0-9]*'
  pull_request:

jobs:
  build:
    name: Build ios and android package
    runs-on: macos-latest
    steps:
      - name: Set up Go 1.19.1
        uses: actions/setup-go@v2
        with:
          go-version: 1.19.1

      - name: Install flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.3.2'

      - name: Check out code
        uses: actions/checkout@v3

      - name: Install the appstore connect api key
        env:
          AC_API_KEY_SECRET_BASE64: ${{ secrets.AC_API_KEY_SECRET_BASE64 }}
        run: |
          AC_API_KEY_SECRET_PATH="$RUNNER_TEMP/key.p8"
          echo "APP_STORE_CONNECT_API_KEY_KEY_FILEPATH=$AC_API_KEY_SECRET_PATH" >> $GITHUB_ENV
          echo -n "$AC_API_KEY_SECRET_BASE64" | base64 --decode --output "$AC_API_KEY_SECRET_PATH"

      - name: get build name and number, install dependencies
        run: |
          go install golang.org/x/mobile/cmd/gomobile@latest
          gomobile init

          flutter pub get

          ##TODO: delete before merge, testing only
          #GITHUB_REF=refs/tags/v0.0.1
          #echo "BUILD_NAME=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
          echo "BUILD_NAME=0.0.1" >> $GITHUB_ENV

          #TODO: get the build number from google play, easier that way
          echo "BUILD_NUMBER=$((GITHUB_RUN_NUMBER+54))" >> $GITHUB_ENV

          touch env.sh

      - name: build ios
        env:
          APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.AC_API_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.AC_API_KEY_ISSUER_ID }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        run: |

          echo "Build: $BUILD_NAME"
          echo "Build number: $GITHUB_RUN_NUMBER"
          cd ios
          pod install
          fastlane beta

      - name: collect ipa artifacts
        uses: actions/upload-artifact@v2
        with:
          name: MobileNebula.ipa
          path: ios/MobileNebula.ipa
